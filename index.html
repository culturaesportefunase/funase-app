<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>FUNASE • Cultura, Lazer e Esportes</title>
  <meta name="theme-color" content="#0b4dbb" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-content">
        <img class="brand-logo" src="/assets/funase-logo.png" alt="FUNASE" />
        <div class="title-section">
          <h1>FUNASE • Cultura, Lazer e Esportes</h1>
          <p class="muted">Sistema de Registro de Atividades</p>
        </div>
        <div class="user-section" id="userSection" style="display:none;margin-left:auto;">
          <span id="userEmail"></span>
          <button class="logout-btn" onclick="logout()">🚪 Sair</button>
        </div>
      </div>
    </header>

    <nav class="menu" id="menu" style="display:none;">
      <div class="menu-container">
        <button class="menu-button" onclick="showSection('dashboardSection')">📊 Dashboard</button>
        <button class="menu-button" onclick="showSection('formSection')">📝 Registrar Atividade</button>
        <button class="menu-button" onclick="showSection('savedFormsSection')">📋 Formulários Salvos</button>
        <button class="menu-button" onclick="showSection('convitesSection')">📨 Convites</button>
        <button class="menu-button" onclick="showSection('contatosSection')">📇 Contatos</button>
      </div>
    </nav>

    <div id="loginSection" class="login-section">
      <div class="login-container card">
        <h3>🔐 Acesso</h3>
        <form id="loginForm" autocomplete="on">
          <label>E-mail</label>
          <input type="email" id="email" placeholder="seu.email@funase.pe.gov.br" required />
          <label>Senha</label>
          <input type="password" id="password" placeholder="Digite sua senha" required />
          <label style="margin-top:6px;"><input type="checkbox" id="rememberMe" /> Lembrar-me</label>
          <button class="btn btn-primary" type="submit" style="margin-top:10px;">Entrar</button>
          <div id="loginMsg" class="muted" style="margin-top:8px;"></div>
        </form>
      </div>
    </div>

    <main class="main-content" id="mainContent" style="display:none;">
      <!-- DASHBOARD -->
      <section id="dashboardSection" class="content-section" style="display:block;">
        <div class="card">
          <h3>📊 Dashboard</h3>
          <div class="row">
            <div class="card"><div class="muted">Atividades salvas</div><div id="kpi-ativ" class="kpi">0</div></div>
            <div class="card"><div class="muted">Contatos</div><div id="kpi-cont" class="kpi">0</div></div>
          </div>
        </div>
        <!-- Envio rápido via API -->
        <div class="card">
          <h3>🤖 WhatsApp API (rápido)</h3>
          <div class="row">
            <div style="flex:1"><label>Número (E.164)</label><input id="wa-numero" placeholder="55819XXXXXXXX" /></div>
            <div style="flex:2"><label>Mensagem</label><textarea id="wa-mensagem" rows="3" placeholder="Convite: atividade X em Y, dia Z às HH:MM."></textarea></div>
          </div>
          <button class="btn btn-primary" onclick="waEnviarApi()" style="margin-top:8px;">Enviar pela API</button>
          <div id="wa-status" class="muted" style="margin-top:8px;"></div>
        </div>
      </section>

      <!-- FORM -->
      <section id="formSection" class="content-section" style="display:none;">
        <div class="card">
          <h3>📝 Registrar Atividade</h3>
          <div class="row">
            <div><label>Data</label><input type="date" id="atv-data" /></div>
            <div><label>Período</label><select id="atv-periodo"><option value="">Selecione…</option><option>Manhã</option><option>Tarde</option><option>Noite</option><option>Integral</option></select></div>
            <div><label>Tipo</label><select id="atv-tipo"><option value="">Selecione…</option><option>Interna</option><option>Externa</option></select></div>
          </div>
          <label>Atividade</label><input id="atv-nome" placeholder="Ex.: Teatro" />
          <label>Descrição</label><textarea id="atv-desc" rows="4"></textarea>
          <button class="btn btn-primary" onclick="salvarAtividade()" style="margin-top:8px;">💾 Salvar</button>
          <div id="atv-msg" class="muted" style="margin-top:8px;"></div>
        </div>
      </section>

      <!-- SALVOS -->
      <section id="savedFormsSection" class="content-section" style="display:none;">
        <div class="card">
          <h3>📋 Formulários Salvos</h3>
          <div id="lista-salvos"></div>
        </div>
      </section>

      <!-- CONVITES -->
      <section id="convitesSection" class="content-section" style="display:none;">
        <div class="card">
          <h3>📨 Convites</h3>
          <ul><li>Oficina de Música — 20/09</li><li>Jogo de Vôlei — 25/09</li></ul>
        </div>
      </section>

      <!-- CONTATOS -->
      <section id="contatosSection" class="content-section" style="display:none;">
        <div class="card">
          <h3>📇 Contatos</h3>
          <div class="row" style="align-items:flex-end">
            <div style="flex:2"><label>Nome</label><input id="ctt-nome" /></div>
            <div><label>Telefone (números)</label><input id="ctt-telefone" placeholder="55819XXXXXXXX" /></div>
            <div><label>E-mail</label><input id="ctt-email" placeholder="pessoa@funase.pe.gov.br" /></div>
            <div><label>Tags</label><input id="ctt-tags" placeholder="cultura, esporte" /></div>
            <div><button class="btn btn-primary" id="ctt-salvarBtn" onclick="contatosSalvar()">Salvar</button><button class="btn" id="ctt-cancelarBtn" onclick="contatosCancelarEdicao()" style="display:none;margin-left:6px;">Cancelar</button></div>
          </div>

          <div class="row" style="margin-top:10px;align-items:center">
            <div style="flex:1"><input id="ctt-busca" placeholder="🔎 Buscar por nome, e-mail ou tag…" oninput="contatosRender()" /></div>
            <div>
              <input type="file" id="ctt-arquivo" accept=".csv" style="display:none" onchange="contatosImportarCSV(this)" />
              <button class="btn" onclick="document.getElementById('ctt-arquivo').click()">⤴️ Importar CSV</button>
              <button class="btn" onclick="contatosExportarCSV()">⬇️ Exportar CSV</button>
              <button class="btn btn-danger" onclick="contatosExcluirSelecionados()">🗑️ Excluir selecionados</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:flex-end">
            <div style="flex:2">
              <label>📝 Mensagem</label><textarea id="ctt-mensagem" rows="3" placeholder="Convite: atividade X em Y, dia Z às HH:MM."></textarea>
            </div>
            <div style="flex:1">
              <label>✉️ Assunto (e-mail)</label><input id="ctt-assunto" placeholder="Convite: atividade X" />
              <div class="row" style="margin-top:10px">
                <button class="btn btn-primary" onclick="contatosGerarWhats()">🔗 WhatsApp (links)</button>
                <button class="btn" onclick="contatosMailto()">✉️ E-mail (mailto BCC)</button>
                <button class="btn" onclick="contatosEnviarWhatsAPI()">🤖 WhatsApp API (selecionados)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:center">
            <div><label><input type="checkbox" id="ctt-checkAll" onclick="contatosToggleTodos(this)" /> Selecionar todos</label></div>
            <div class="muted" style="margin-left:auto" id="ctt-contagem"></div>
          </div>
          <div class="table-wrap" style="overflow:auto;">
            <table id="ctt-tabela">
              <thead><tr><th></th><th>Nome</th><th>Telefone</th><th>E-mail</th><th>Tags</th><th style="width:120px">Ações</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="linksZap" class="list" style="margin-top:12px;"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
  // ========== Estado & Utilidades ==========
  let currentUser=null; const CKEY='contatos';
  function setLoginMsg(t,ok=false){const el=document.getElementById('loginMsg');el.textContent=t||'';el.style.color=ok?'#16a34a':'#ef4444';}
  function showSection(id){document.querySelectorAll('.content-section').forEach(s=>s.style.display='none'); const t=document.getElementById(id); if(t) t.style.display='block'; if(id==='savedFormsSection') renderSalvos(); if(id==='dashboardSection') renderKPIs(); if(id==='contatosSection') contatosRender();}
  function logout(){currentUser=null; localStorage.removeItem('rememberedUser'); document.getElementById('loginSection').style.display='block'; document.getElementById('menu').style.display='none'; document.getElementById('mainContent').style.display='none'; document.getElementById('userSection').style.display='none'; setLoginMsg('');}

  // ========== Login ==========
  window.addEventListener('DOMContentLoaded',()=>{
    const r=localStorage.getItem('rememberedUser'); if(r){email.value=r; rememberMe.checked=true;}
    loginForm.addEventListener('submit',(e)=>{
      e.preventDefault();
      const em=(email.value||'').trim().toLowerCase(); const ps=(password.value||'').trim();
      if(!em.endsWith('@funase.pe.gov.br')) return setLoginMsg('Use apenas e-mails @funase.pe.gov.br');
      if(ps!=='funase2024') return setLoginMsg('Senha incorreta');
      if(rememberMe.checked) localStorage.setItem('rememberedUser', em);
      currentUser=em; loginSection.style.display='none'; menu.style.display='block'; mainContent.style.display='block'; userSection.style.display='block'; userEmail.textContent=em; showSection('dashboardSection');
    });
  });

  // ========== Atividades ==========
  function salvarAtividade(){
    const a={id:Date.now(),data:document.getElementById('atv-data').value,periodo:document.getElementById('atv-periodo').value,tipo:document.getElementById('atv-tipo').value,nome:document.getElementById('atv-nome').value,desc:document.getElementById('atv-desc').value};
    const lista=JSON.parse(localStorage.getItem('atividades')||'[]'); lista.push(a); localStorage.setItem('atividades', JSON.stringify(lista)); document.getElementById('atv-msg').textContent='Salvo!'; renderKPIs();
  }
  function renderSalvos(){
    const box=document.getElementById('lista-salvos'); const lista=JSON.parse(localStorage.getItem('atividades')||'[]');
    if(!lista.length){ box.innerHTML='<p class="muted">Nenhum formulário salvo.</p>'; return; }
    box.innerHTML='<ul>'+lista.map(a=>`<li>${a.nome||'(sem nome)'} — ${a.data||'-'}</li>`).join('')+'</ul>';
  }
  function renderKPIs(){ const lista=JSON.parse(localStorage.getItem('atividades')||'[]'); const ctts=JSON.parse(localStorage.getItem(CKEY)||'[]'); document.getElementById('kpi-ativ').textContent=lista.length; document.getElementById('kpi-cont').textContent=ctts.length; }

  // ========== Contatos (CRUD) ==========
  let contatos=JSON.parse(localStorage.getItem(CKEY)||'[]'); let editId=null;
  function contatosSalvar(){
    const nome=(document.getElementById('ctt-nome').value||'').trim();
    let telefone=(document.getElementById('ctt-telefone').value||'').replace(/\D/g,'');
    const email=(document.getElementById('ctt-email').value||'').trim().toLowerCase();
    const tags=(document.getElementById('ctt-tags').value||'').trim();
    if(!telefone && !email){ alert('Informe ao menos telefone ou e-mail.'); return; }
    if(telefone && !telefone.startsWith('55')) telefone='55'+telefone;
    if(editId){ contatos=contatos.map(c=>c.id===editId?{...c,nome,telefone,email,tags}:c); } else { contatos.push({id:Date.now(),nome,telefone,email,tags}); }
    localStorage.setItem(CKEY, JSON.stringify(contatos)); contatosLimparForm(); contatosRender(); renderKPIs();
  }
  function contatosCancelarEdicao(){ editId=null; contatosLimparForm(); }
  function contatosLimparForm(){ ['ctt-nome','ctt-telefone','ctt-email','ctt-tags'].forEach(id=>document.getElementById(id).value=''); document.getElementById('ctt-salvarBtn').textContent='Salvar'; document.getElementById('ctt-cancelarBtn').style.display='none'; }
  function contatosEditar(id){ const c=contatos.find(x=>x.id===id); if(!c) return; ctt-nome.value=c.nome||''; ctt-telefone.value=(c.telefone||'').replace(/^55/,''); ctt-email.value=c.email||''; ctt-tags.value=c.tags||''; editId=id; ctt-salvarBtn.textContent='Atualizar'; ctt-cancelarBtn.style.display='inline-block'; }
  function contatosExcluir(id){ if(!confirm('Excluir este contato?')) return; contatos=contatos.filter(c=>c.id!==id); localStorage.setItem(CKEY, JSON.stringify(contatos)); contatosRender(); renderKPIs(); }
  function contatosExcluirSelecionados(){ const ids=[...document.querySelectorAll('.ctt-check:checked')].map(ch=>Number(ch.value)); if(!ids.length) return alert('Selecione contatos.'); if(!confirm(`Excluir ${ids.length} contato(s)?`)) return; contatos=contatos.filter(c=>!ids.includes(c.id)); localStorage.setItem(CKEY, JSON.stringify(contatos)); contatosRender(); renderKPIs(); }
  function contatosToggleTodos(chk){ document.querySelectorAll('.ctt-check').forEach(c=>c.checked=chk.checked); }
  function contatosFiltrados(){ const q=(document.getElementById('ctt-busca').value||'').toLowerCase().trim(); if(!q) return contatos; return contatos.filter(c=>[c.nome,c.email,c.tags,c.telefone].join(' ').toLowerCase().includes(q)); }
  function contatosRender(){
    const data=contatosFiltrados(); const tb=document.querySelector('#ctt-tabela tbody'); tb.innerHTML='';
    data.forEach(c=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" class="ctt-check" value="${c.id}"></td><td>${c.nome||'-'}</td><td>${c.telefone||'-'}</td><td>${c.email||'-'}</td><td>${c.tags||'-'}</td><td><button class="btn" onclick="contatosEditar(${c.id})">Editar</button> <button class="btn btn-danger" onclick="contatosExcluir(${c.id})">Excluir</button></td>`; tb.appendChild(tr); });
    document.getElementById('ctt-contagem').textContent=`${data.length} contato(s)`; const all=document.getElementById('ctt-checkAll'); if(all) all.checked=false;
  }

  // ========== Disparos Grátis ==========
  function linhasValidas(txt){return (txt||'').split(/\r?\n|,|;/).map(s=>s.trim()).filter(Boolean);}
  function contatosSelecionados(){ const ids=[...document.querySelectorAll('.ctt-check:checked')].map(ch=>Number(ch.value)); return contatos.filter(c=>ids.includes(c.id)); }
  function contatosGerarWhats(){
    const sel=contatosSelecionados(); const msg=document.getElementById('ctt-mensagem').value||''; const withTel=sel.filter(c=>c.telefone);
    const box=document.getElementById('linksZap'); box.innerHTML=''; if(!withTel.length){ box.innerHTML='<p class="muted">Nenhum telefone válido.</p>'; return; }
    withTel.forEach(c=>{ const div=document.createElement('div'); div.className='card'; const a=document.createElement('a'); a.href=`https://wa.me/${c.telefone}?text=${encodeURIComponent(msg)}`; a.target='_blank'; a.rel='noopener'; a.textContent=`Abrir conversa com ${c.nome||c.telefone}`; div.appendChild(a); box.appendChild(div); });
  }
  function contatosMailto(){
    const sel=contatosSelecionados(); const emails=sel.map(c=>c.email).filter(e=>/.+@.+\..+/.test(e)); if(!emails.length) return alert('Nenhum e-mail válido nos selecionados.');
    const assunto=document.getElementById('ctt-assunto').value||'Convite FUNASE'; const corpo=document.getElementById('ctt-mensagem').value||'';
    const link=`mailto:?bcc=${encodeURIComponent(emails.join(','))}&subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`; window.location.href=link;
  }

  // ========== WhatsApp API (Meta) ==========
  async function enviarWhatsAPI(para, texto, template=null){
    const payload = template ? { to: para, template } : { to: para, text: texto || '' };
    const resp = await fetch('/api/whatsapp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await resp.json(); if(!resp.ok){ const msg=(data&&(data.error?.message||data.message))||JSON.stringify(data); throw new Error(msg||'Falha no envio'); } return data;
  }
  async function contatosEnviarWhatsAPI(){
    const sel=contatosSelecionados(); const withTel=sel.filter(c=>c.telefone); if(!withTel.length) return alert('Selecione contatos com telefone.');
    const texto=document.getElementById('ctt-mensagem').value||''; if(withTel.length>5 && !confirm(`Enviar via API para ${withTel.length} contato(s)?`)) return;
    let ok=0,err=0; for(const c of withTel){ try{ await enviarWhatsAPI(c.telefone, texto); ok++; }catch(e){ console.error('Falha',c,e); err++; } }
    alert(`Concluído: ${ok} enviado(s) • ${err} falha(s)`);
  }
  async function waEnviarApi(){
    const num=(document.getElementById('wa-numero').value||'').replace(/\D/g,''); const msg=document.getElementById('wa-mensagem').value||''; const out=document.getElementById('wa-status');
    if(!num){ out.textContent='Informe o número no formato E.164 (ex.: 55819...)'; out.style.color='#ef4444'; return; }
    out.textContent='Enviando...'; out.style.color='#64748b';
    try{ const data=await enviarWhatsAPI(num, msg); out.textContent='✅ Enviado! wamid: '+(data?.messages?.[0]?.id||'(sem id)'); out.style.color='#16a34a'; }catch(e){ out.textContent='❌ Erro: '+e.message; out.style.color='#ef4444'; }
  }

  // ========== Service Worker ==========
  if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/service-worker.js').catch(console.error); }); }
  </script>
</body>
</html>
